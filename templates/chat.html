<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AI Grandchild Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="chat-container">

        <div class="chat-header">
            <h2>AI Grandchild Bot</h2>
        </div>

        <!-- LINEé¢¨ãƒ­ã‚° -->
        <div id="messages" class="messages"></div>

        <!-- éŸ³å£°ãƒ­ã‚° -->
        <div id="voice-logs" class="voice-logs"></div>

        <!-- å…¥åŠ›æ¬„ -->
        <div class="input-area">
            <input id="textInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ› (éŸ³å£°ã§ã‚‚å¯)">
            <button id="sendBtn">é€ä¿¡</button>
        </div>

        <button id="voiceBtn" class="voice-button">ğŸ¤</button>

    </div>

    <script>
        const messagesDiv = document.getElementById("messages");
        const voiceLogsDiv = document.getElementById("voice-logs");
        const sendBtn = document.getElementById("sendBtn");
        const textInput = document.getElementById("textInput");
        const voiceBtn = document.getElementById("voiceBtn");

        // ----------------------------------------------------------
        // LINEé¢¨å¹ãå‡ºã—ï¼šå³ï¼ˆã‚ãªãŸï¼‰ï½œå·¦ï¼ˆAIï¼‰
        // ----------------------------------------------------------
        function addBubble(sender, text) {
            const div = document.createElement("div");
            div.className = sender === "ã‚ãªãŸ" ? "bubble-right" : "bubble-left";
            div.innerHTML = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ----------------------------------------------------------
        // éŸ³å£°ãƒ­ã‚°è¿½åŠ 
        // ----------------------------------------------------------
        function addVoiceLog(url) {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = url;
            audio.style.width = "100%";
            audio.className = "voice-log-item";

            voiceLogsDiv.appendChild(audio);
            voiceLogsDiv.scrollTop = voiceLogsDiv.scrollHeight;
        }

        // ----------------------------------------------------------
        // éŸ³å£°èªè­˜ï¼ˆè‡ªå‹•ONï¼‰
        // ----------------------------------------------------------
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = "ja-JP";
            recognition.continuous = true;

            recognition.onresult = function(event) {
                const text = event.results[event.results.length - 1][0].transcript;
                sendText(text);
            };

            recognition.start();
        }

        voiceBtn.onclick = () => {
            if (recognition) recognition.start();
        };

        // ----------------------------------------------------------
        // é€ä¿¡å‡¦ç†
        // ----------------------------------------------------------
        sendBtn.onclick = () => {
            const text = textInput.value.trim();
            if (text) sendText(text);
        };

        textInput.addEventListener("keydown", e => {
            if (e.key === "Enter") sendBtn.click();
        });

        // ----------------------------------------------------------
        // /api/chat
        // ----------------------------------------------------------
        function sendText(text) {
            addBubble("ã‚ãªãŸ", text);
            textInput.value = "";

            fetch("/api/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: text })
            })
            .then(res => res.json())
            .then(data => {
                addBubble("AIå­«", data.reply);

                if (data.voice_url) {
                    addVoiceLog(data.voice_url);
                }
            });
        }
    </script>

</body>
</html>
