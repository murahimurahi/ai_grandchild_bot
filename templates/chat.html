<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AI Grandchild Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="chat-container">

        <div class="chat-header">
            <h2>AI Grandchild Bot</h2>
        </div>

        <div id="messages" class="messages"></div>

        <!-- Èü≥Â£∞„É≠„Ç∞„Éñ„É≠„ÉÉ„ÇØÔºàÂêÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰∏ã„Å´ JS „ÅßËøΩÂä†„Åï„Çå„ÇãÔºâ -->
        <div id="voice-logs" class="voice-logs"></div>

        <!-- ÂÖ•ÂäõÊ¨Ñ -->
        <div class="input-area">
            <input id="textInput" type="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ (Èü≥Â£∞„Åß„ÇÇÂèØ)">
            <button id="sendBtn">ÈÄÅ‰ø°</button>
        </div>

        <!-- Èü≥Â£∞„Éú„Çø„É≥ÔºàË¶ã„ÅüÁõÆ„ÅØÊÆã„Åô„ÅåËá™ÂãïË™çË≠òONÔºâ -->
        <button id="voiceBtn" class="voice-button">üé§</button>

    </div>

    <script>
        const messagesDiv = document.getElementById("messages");
        const voiceLogsDiv = document.getElementById("voice-logs");
        const sendBtn = document.getElementById("sendBtn");
        const textInput = document.getElementById("textInput");
        const voiceBtn = document.getElementById("voiceBtn");

        // ---------------------------
        // Èü≥Â£∞Ë™çË≠òÔºàËá™Âãï„Çπ„Çø„Éº„ÉàÔºâ
        // ---------------------------
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = "ja-JP";
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const text = event.results[event.results.length - 1][0].transcript;
                sendText(text);
            };

            recognition.start();
        }

        voiceBtn.onclick = () => {
            // „Éú„Çø„É≥„ÅØÊÆã„Åô„Åå„ÄÅËá™Âãï„ÅßÂ∏∏ÊôÇON„Å™„ÅÆ„Åß‰∫àÂÇô
            if (recognition) recognition.start();
        };

        // ---------------------------
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
        // ---------------------------
        sendBtn.onclick = () => {
            const text = textInput.value.trim();
            if (text !== "") sendText(text);
        };

        textInput.addEventListener("keydown", e => {
            if (e.key === "Enter") sendBtn.click();
        });

        // ---------------------------
        // „Çµ„Éº„Éê„Éº„Å∏ÈÄÅ‰ø°
        // ---------------------------
        function sendText(text) {
            addMessage("„ÅÇ„Å™„Åü", text);
            textInput.value = "";

            fetch("/api/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: text })
            })
            .then(res => res.json())
            .then(data => {
                addMessage("AIÂ≠´", data.reply);

                // Èü≥Â£∞URLÔºà‰ºöË©±„Åî„Å®Ôºâ
                if (data.voice_url) {
                    addVoiceLog(data.voice_url);
                }
            });
        }

        // ---------------------------
        // „É°„ÉÉ„Çª„Éº„Ç∏ÊèèÁîª
        // ---------------------------
        function addMessage(sender, text) {
            const div = document.createElement("div");
            div.className = "message";
            div.innerHTML = `<strong>${sender}Ôºö</strong> ${text}`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ---------------------------
        // Èü≥Â£∞„É≠„Ç∞ËøΩÂä†ÔºàÂêÑ‰ºöË©±„ÅÆ‰∏ãÔºâ
        // ---------------------------
        function addVoiceLog(url) {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = url;
            audio.className = "voice-log-item";

            voiceLogsDiv.appendChild(audio);
            voiceLogsDiv.scrollTop = voiceLogsDiv.scrollHeight;
        }
    </script>

</body>
</html>
