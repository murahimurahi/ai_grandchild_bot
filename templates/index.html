<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おはなし横丁</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>おはなし横丁</h1>
    <p>やさしく話せる、あたたかい時間をどうぞ。</p>

    <form id="talkForm">
      <p>① 思ったことを一言つぶやく。</p>
      <p>② 「話しかける」ボタン、または音声入力（マイクの絵のボタン）で話せます。</p>
      <p>③ ゆうくんがすぐにやさしく返してくれます。</p>

      <textarea id="message" placeholder="こんにちは"></textarea><br>
      <button type="button" id="voiceBtn">🎙 マイク</button>
      <button type="submit" id="sendBtn">話しかける</button>
    </form>

    <div id="response"></div>
  </div>

  <script>
  const form = document.getElementById('talkForm');
  const responseDiv = document.getElementById('response');
  const voiceBtn = document.getElementById('voiceBtn');

  // 🚀 会話送信処理
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = document.getElementById('message').value.trim();
    if (!message) return;

    responseDiv.innerHTML = "考え中…";

    try {
      const res = await fetch('/talk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await res.json();

      responseDiv.innerHTML = `<p>${data.reply}</p>`;

      // 🎧 自動で音声を再生（ボタン不要）
      if (data.audio_url) {
        const audio = new Audio(data.audio_url);
        audio.autoplay = true;
        audio.play().then(() => {
          console.log("🎵 自動再生成功");
        }).catch(err => {
          console.warn("⚠️ 自動再生がブロックされた場合:", err);
          // 代替: 再生ボタンを表示
          responseDiv.innerHTML += `
            <p>▶️ 音声の再生がブロックされました。下のボタンを押してください。</p>
            <audio controls src="${data.audio_url}" autoplay></audio>
          `;
        });
      }
    } catch (err) {
      responseDiv.innerHTML = "通信エラーが発生しました。";
      console.error(err);
    }
  });

  // 🎙 音声入力（Chrome対応）
  voiceBtn.addEventListener('click', () => {
    try {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.start();
      recognition.onresult = (e) => {
        document.getElementById('message').value = e.results[0][0].transcript;
        form.requestSubmit(); // 自動送信
      };
      recognition.onerror = () => {
        alert("マイクが使用できません。設定を確認してください。");
      };
    } catch (err) {
      alert("お使いのブラウザは音声入力に対応していません。");
    }
  });
  </script>
</body>
</html>
