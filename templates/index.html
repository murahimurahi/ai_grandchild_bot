<script>
/* ---------------------------------------------------
   ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ä¿å­˜ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‹éŸ³å£°URLï¼‰
--------------------------------------------------- */
function saveLog(userText, botText, audioUrl) {
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");

    logs.push({
        timestamp: new Date().toISOString(),
        user: userText,
        bot: botText,
        audio: audioUrl
    });

    localStorage.setItem("logs", JSON.stringify(logs));
}

/* ---------------------------------------------------
   éŸ³å£°å…¥åŠ› â†’ è‡ªå‹•é€ä¿¡ï¼ˆ7ç§’ or 15ç§’ï¼‰
--------------------------------------------------- */
let recognition;

try {
    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

    recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.interimResults = false;

    recognition.onresult = function(e) {
        const text = e.results[0][0].transcript;
        document.getElementById("userInput").value = text;

        // çŸ­æ–‡ â†’ 7ç§’ / é•·æ–‡ â†’ 15ç§’
        let delay = text.length <= 30 ? 7000 : 15000;

        document.getElementById("reply").innerText =
            `èã“ãˆãŸã‚ˆã€‚ã€Œ${text}ã€\nå°‘ã—å¾…ã£ã¦ã¦ã­â€¦`;

        setTimeout(() => {
            autoSend(text);
        }, delay);
    };

} catch (e) {
    alert("éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚");
}

document.getElementById("micBtn").onclick = () => {
    if (recognition) recognition.start();
};

/* ---------------------------------------------------
   è‡ªå‹•é€ä¿¡é–¢æ•°
--------------------------------------------------- */
async function autoSend(text) {
    const res = await fetch("/talk", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
    });

    const data = await res.json();

    saveLog(text, data.reply, data.audio_url);

    document.getElementById("reply").innerText = data.reply;

    const audio = document.getElementById("voice");
    audio.src = data.audio_url;
    audio.play();
}

/* ---------------------------------------------------
   æ‰‹å‹•é€ä¿¡
--------------------------------------------------- */
document.getElementById("talkBtn").onclick = () => {
    const text = document.getElementById("userInput").value.trim();
    if (!text) return;
    autoSend(text);
};

/* ---------------------------------------------------
   ãƒ­ã‚°è¡¨ç¤º
--------------------------------------------------- */
function showLogs() {
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");
    const box = document.getElementById("logs-box");

    if (logs.length === 0) {
        box.innerHTML = "<p>ã¾ã ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
    }

    box.innerHTML = logs.map(l => `
        <div class="log-item">
            <div>ğŸ•’ ${new Date(l.timestamp).toLocaleString()}</div>
            <div><b>ã‚ãªãŸï¼š</b> ${l.user}</div>
            <div><b>ã‚†ã†ãã‚“ï¼š</b> ${l.bot}</div>
            <audio controls src="${l.audio}"></audio>
        </div>
    `).join("");
}
</script>
