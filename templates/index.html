<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おはなし横丁</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

    <h1>おはなし横丁</h1>
    <p class="sub">ゆうくんと、楽しく話す時間だよ。</p>

    <!-- 入力欄（入力は保持する） -->
    <textarea id="userInput" placeholder="話したいことを書いてね"></textarea>

    <div class="buttons">
        <button id="voiceBtn" class="mic-off">🎤 音声入力</button>
        <button id="sendBtn">話しかける</button>
    </div>

    <!-- 説明文 -->
    <div class="info">
        👉 音声入力は5秒話すと自動で送信されるよ。<br>
        👉 下のカレンダーから過去の会話も見られるよ。
    </div>

    <!-- 返事 -->
    <div id="responseArea"></div>

    <!-- 音声 -->
    <audio id="voicePlayer" controls preload="auto" style="display:none;"></audio>

    <p><a href="/logs">📁 過去の会話カレンダーを見る</a></p>

</div>


<script>
/* 音声入力まわり ==================================*/
let recognition;
let timer = null;

try {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = "ja-JP";
    recognition.interimResults = true;

    recognition.onstart = () => {
        document.getElementById("voiceBtn").classList.add("mic-on");
    };

    recognition.onend = () => {
        document.getElementById("voiceBtn").classList.remove("mic-on");
    };

    recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        document.getElementById("userInput").value = text;

        if (timer) clearTimeout(timer);
        timer = setTimeout(() => { sendMessage(); }, 5000);
    };

} catch (e) {
    console.error("音声認識エラー:", e);
}

document.getElementById("voiceBtn").onclick = () => {
    try { recognition.start(); } catch {}
};


/* 送信処理 ==================================*/
document.getElementById("sendBtn").onclick = () => {
    sendMessage();
};

function sendMessage() {
    const text = document.getElementById("userInput").value.trim();
    if (!text) return;

    document.getElementById("responseArea").innerHTML = "ゆうくんが考え中…";

    fetch("/talk", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("responseArea").innerHTML = data.reply;

        const player = document.getElementById("voicePlayer");
        player.style.display = "block";
        player.src = data.audio_url + "?t=" + Date.now();

        player.load();
        setTimeout(() => player.play(), 150);
    });

    // 入力欄は消さない！
}
</script>

</body>
</html>
