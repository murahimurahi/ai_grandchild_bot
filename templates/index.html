<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãŠã¯ãªã—æ¨ªä¸</title>
    <style>
        body {
            font-family: "Hiragino Sans", sans-serif;
            background:#fafafa;
            padding:40px;
            text-align:center;
        }
        #logArea {
            margin-top: 40px;
            font-size:14px;
            color:#555;
        }
        audio { margin-top:10px; }
    </style>
</head>
<body>

<h1>ãŠã¯ãªã—æ¨ªä¸</h1>
<p>ã‚†ã†ãã‚“ã¨ã€ã‚„ã•ã—ãè©±ã›ã‚‹æ™‚é–“ã‚’ã©ã†ãã€‚</p>
<p>â‘  æ€ã£ãŸã“ã¨ã‚’ä¸€è¨€ã¤ã¶ã‚„ãã€‚</p>
<p>â‘¡ã€Œè©±ã—ã‹ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã§è©±ã›ã¾ã™ã€‚</p>

<textarea id="user_input" rows="3" style="width:80%;font-size:18px;"></textarea><br><br>

<button id="voiceBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
<button id="askBtn">è©±ã—ã‹ã‘ã‚‹</button>

<div id="responseArea" style="margin-top:30px;font-size:18px;"></div>

<div id="logArea">
    <a href="/logs" target="_blank">ğŸ“˜ éå»ã®ä¼šè©±ãƒ­ã‚°ã‚’è¦‹ã‚‹</a>
</div>

<script>
    //---------------------------------------------------
    // éŸ³å£°å…¥åŠ› 5 ç§’ & é€”åˆ‡ã‚Œé˜²æ­¢ 0.2ç§’é…å»¶
    //---------------------------------------------------
    const voiceBtn = document.getElementById("voiceBtn");
    let mediaRecorder;
    let audioChunks = [];

    voiceBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            mediaRecorder = new MediaRecorder(stream);

            // é€”åˆ‡ã‚Œé˜²æ­¢ â†’ éŒ²éŸ³é–‹å§‹ã‚’å°‘ã—é…ã‚‰ã›ã‚‹
            setTimeout(() => mediaRecorder.start(), 200);

            setTimeout(() => mediaRecorder.stop(), 5000); // â† éŒ²éŸ³5ç§’

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, {type:"audio/mp3"});
                const formData = new FormData();
                formData.append("audio", blob, "voice.mp3");

                const res = await fetch("/voice", {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();
                document.getElementById("user_input").value = data.text;  // â† å…¥åŠ›æ¬„ã«æ®‹ã™

                sendText();
            };
        } catch (e) {
            alert("ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        }
    });


    //---------------------------------------------------
    // ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
    //---------------------------------------------------
    document.getElementById("askBtn").addEventListener("click", sendText);

    async function sendText() {
        const text = document.getElementById("user_input").value;
        if (!text) return;

        const res = await fetch("/talk", {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ user_text: text })
        });

        const data = await res.json();

        // è¿”ç­”ãƒ†ã‚­ã‚¹ãƒˆ
        document.getElementById("responseArea").innerHTML =
            `${data.reply}<br><br><audio controls src="${data.audio_url}"></audio>`;
    }
</script>

</body>
</html>
