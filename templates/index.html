<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãŠã¯ãªã—æ¨ªä¸</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>ãŠã¯ãªã—æ¨ªä¸</h1>
    <p>ã‚„ã•ã—ãè©±ã›ã‚‹ã€ã‚ãŸãŸã‹ã„æ™‚é–“ã‚’ã©ã†ãã€‚</p>

    <form id="talkForm">
      <p>â‘  æ€ã£ãŸã“ã¨ã‚’ä¸€è¨€ã¤ã¶ã‚„ãã€‚</p>
      <p>â‘¡ ã€Œè©±ã—ã‹ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯éŸ³å£°å…¥åŠ›ï¼ˆãƒã‚¤ã‚¯ã®çµµã®ãƒœã‚¿ãƒ³ï¼‰ã§è©±ã›ã¾ã™ã€‚</p>
      <p>â‘¢ ã‚†ã†ãã‚“ãŒã™ãã«ã‚„ã•ã—ãè¿”ã—ã¦ãã‚Œã¾ã™ã€‚</p>

      <textarea id="message" placeholder="ã“ã‚“ã«ã¡ã¯"></textarea><br>
      <button type="button" id="voiceBtn">ğŸ™ ãƒã‚¤ã‚¯</button>
      <button type="submit" id="sendBtn">è©±ã—ã‹ã‘ã‚‹</button>
    </form>

    <div id="response"></div>
  </div>

  <script>
  const form = document.getElementById('talkForm');
  const responseDiv = document.getElementById('response');
  const voiceBtn = document.getElementById('voiceBtn');

  // ğŸš€ ä¼šè©±é€ä¿¡å‡¦ç†
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = document.getElementById('message').value.trim();
    if (!message) return;

    responseDiv.innerHTML = "è€ƒãˆä¸­â€¦";

    try {
      const res = await fetch('/talk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await res.json();

      responseDiv.innerHTML = `<p>${data.reply}</p>`;

      // ğŸ§ è‡ªå‹•éŸ³å£°å†ç”Ÿï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä»£æ›¿ï¼‰
      if (data.audio_url) {
        const audio = new Audio(data.audio_url);
        audio.play().catch(() => {
          responseDiv.innerHTML += `
            <p>â–¶ï¸ å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦èã„ã¦ã­ã€‚</p>
            <audio controls src="${data.audio_url}"></audio>
          `;
        });
      }
    } catch (err) {
      responseDiv.innerHTML = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      console.error(err);
    }
  });

  // ğŸ™ éŸ³å£°å…¥åŠ›ï¼ˆChromeå¯¾å¿œï¼‰
  voiceBtn.addEventListener('click', () => {
    try {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.start();
      recognition.onresult = (e) => {
        document.getElementById('message').value = e.results[0][0].transcript;
        form.requestSubmit(); // è‡ªå‹•é€ä¿¡
      };
      recognition.onerror = () => {
        alert("ãƒã‚¤ã‚¯ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      };
    } catch (err) {
      alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    }
  });
  </script>
</body>
</html>
