<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>おはなし横丁</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>おはなし横丁</h1>
    <p class="subtitle">やさしく話せる、あたたかい時間をどうぞ。</p>

    <form id="talkForm">
      <div class="radio-group">
        <label><input type="radio" name="character" value="みさちゃん（孫娘）" checked>みさちゃん（孫娘）</label>
        <label><input type="radio" name="character" value="ゆうくん（孫息子）">ゆうくん（孫息子）</label>
        <label><input type="radio" name="character" value="ソウタ（息子）">ソウタ（息子）</label>
      </div>

      <ol class="howto">
        <li>思ったことを一言つぶやく。</li>
        <li>「話しかける」または音声入力で話せます。</li>
        <li>AIがすぐにやさしく返してくれます。</li>
      </ol>

      <textarea id="message" placeholder="こんにちは、今日はね…"></textarea>

      <div class="btns">
        <button type="button" id="voiceBtn" class="btn blue">🎙 音声入力</button>
        <button type="submit" class="btn pink">話しかける</button>
      </div>
    </form>

    <div id="replyArea" class="reply"></div>
    <footer>© おはなし横丁</footer>
  </div>

  <script>
    const form = document.getElementById("talkForm");
    const replyArea = document.getElementById("replyArea");
    const voiceBtn = document.getElementById("voiceBtn");
    const messageInput = document.getElementById("message");

    // 🎤 音声入力ボタンで自動送信
    voiceBtn.addEventListener("click", () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "ja-JP";
      recognition.start();

      recognition.onresult = (e) => {
        messageInput.value = e.results[0][0].transcript;
        sendMessage();  // 入力後自動送信
      };
      recognition.onerror = () => {
        replyArea.textContent = "音声を認識できませんでした。";
      };
    });

    // ✉️ フォーム送信（文字入力）
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      sendMessage();
    });

    // 💬 サーバへ送信
    function sendMessage() {
      const message = messageInput.value.trim();
      const character = document.querySelector('input[name="character"]:checked').value;
      if (!message) return;

      replyArea.innerHTML = "考え中…";

      fetch("/talk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, character })
      })
      .then(res => res.json())
      .then(data => {
        replyArea.innerHTML = `
          <p>${data.reply}</p>
          <audio controls autoplay src="${data.audio_url}"></audio>
        `;
      })
      .catch(() => {
        replyArea.textContent = "接続がうまくいきませんでした。";
      });
    }
  </script>
</body>
</html>
