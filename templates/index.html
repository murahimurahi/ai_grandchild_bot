<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãŠã¯ãªã—æ¨ªä¸</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="{{ season }}">
  <div class="container">
    <h1>ãŠã¯ãªã—æ¨ªä¸</h1>
    <p>ã‚„ã•ã—ãè©±ã›ã‚‹ã€ã‚ãŸãŸã‹ã„æ™‚é–“ã‚’ã©ã†ãã€‚</p>

    <form id="talkForm">
      <p>â‘  æ€ã£ãŸã“ã¨ã‚’ä¸€è¨€ã¤ã¶ã‚„ãã€‚</p>
      <p>â‘¡ ã€Œè©±ã—ã‹ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯éŸ³å£°å…¥åŠ›ï¼ˆãƒã‚¤ã‚¯ã®çµµã®ãƒœã‚¿ãƒ³ï¼‰ã§è©±ã›ã¾ã™ã€‚</p>
      <p>â‘¢ ã‚†ã†ãã‚“ãŒã™ãã«ã‚„ã•ã—ãè¿”ã—ã¦ãã‚Œã¾ã™ã€‚</p>

      <textarea id="message" placeholder="ã“ã‚“ã«ã¡ã¯"></textarea><br>

      <div class="mic-controls">
        <button type="button" id="voiceBtn" class="mic-btn">ğŸ™ ãƒã‚¤ã‚¯</button>

        <div class="mode-box">
          <label class="mode-switch">
            <input type="checkbox" id="longMode">
            <span class="slider"></span>
            <span class="mode-label">çŸ­æ–‡</span>
          </label>
          <small class="mode-hint">ï¼ˆé•·ãè©±ã—ãŸã„æ™‚ã¯åˆ‡ã‚Šæ›¿ãˆã¦ã­ï¼‰</small>
        </div>
      </div>

      <button type="submit">è©±ã—ã‹ã‘ã‚‹</button>
    </form>

    <div id="response"></div>
    <div id="subtitle" class="subtitle"></div>

    <p class="loglink"><a href="/logs">ğŸ“† éå»ã®ä¼šè©±ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã‚‹</a></p>
  </div>

  <script>
  const form = document.getElementById('talkForm');
  const responseDiv = document.getElementById('response');
  const micBtn = document.getElementById('voiceBtn');
  const modeSwitch = document.getElementById('longMode');
  const modeLabel = document.querySelector('.mode-label');
  const subtitleDiv = document.getElementById('subtitle');

  // ğŸ” ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  modeSwitch.addEventListener('change', () => {
    modeLabel.textContent = modeSwitch.checked ? "é•·æ–‡" : "çŸ­æ–‡";
  });

  // ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = document.getElementById('message').value;
    if (!message.trim()) return;
    responseDiv.innerHTML = "è€ƒãˆä¸­â€¦";
    subtitleDiv.textContent = "";

    const res = await fetch('/talk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });

    const data = await res.json();
    responseDiv.innerHTML = `<p>${data.reply}</p>`;

    if (data.audio_url) {
      const audio = new Audio(data.audio_url);
      audio.play().catch(() => {
        responseDiv.innerHTML += `<p>â–¶ï¸ å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦èã„ã¦ã­ã€‚</p>
        <audio controls src="${data.audio_url}"></audio>`;
      });
    }
  });

  // ğŸ™ éŸ³å£°èªè­˜ï¼‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­—å¹•
  let recognition;
  micBtn.addEventListener('click', () => {
    if (recognition) recognition.stop();

    recognition = new webkitSpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.interimResults = true;
    recognition.continuous = true;
    recognition.maxAlternatives = 1;

    document.getElementById('message').value = "";
    recognition.start();
    micBtn.classList.add('recording');
    subtitleDiv.textContent = "ğŸ¤ è©±ã—ã¦ãã ã•ã„â€¦";

    const limit = modeSwitch.checked ? 60000 : 15000; // é•·æ–‡1åˆ† / çŸ­æ–‡15ç§’
    const stopTimer = setTimeout(() => recognition.stop(), limit);

    recognition.onresult = (e) => {
      let transcript = "";
      for (let i = 0; i < e.results.length; i++) {
        transcript += e.results[i][0].transcript;
      }
      document.getElementById('message').value = transcript;
      subtitleDiv.textContent = transcript;
    };

    recognition.onend = () => {
      clearTimeout(stopTimer);
      micBtn.classList.remove('recording');
      subtitleDiv.textContent = "";
      const text = document.getElementById('message').value.trim();
      if (text) form.requestSubmit();
    };

    recognition.onerror = (e) => {
      micBtn.classList.remove('recording');
      subtitleDiv.textContent = "âš ï¸ éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      console.log("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", e.error);
    };
  });

  // ğŸ•Š é€šçŸ¥ï¼ˆæœ9æ™‚ï¼‰
  if ('Notification' in window) {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        const now = new Date();
        const nineAM = new Date();
        nineAM.setHours(9, 0, 0, 0);
        const delay = nineAM - now > 0 ? nineAM - now : nineAM.getTime() + 86400000 - now.getTime();
        setTimeout(() => {
          new Notification("ã‚†ã†ãã‚“ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", {
            body: "ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚å°‘ã—ã ã‘è©±ãã†ã‹ï¼ŸğŸ˜Š",
            icon: "/static/icon.png"
          });
        }, delay);
      }
    });
  }
  </script>
</body>
</html>
