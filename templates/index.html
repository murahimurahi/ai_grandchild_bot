<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠã¯ãªã—æ¨ªä¸</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <h1>ãŠã¯ãªã—æ¨ªä¸</h1>
        <p>ã‚†ã†ãã‚“ã¨ã€ã‚„ã•ã—ãè©±ã›ã‚‹æ™‚é–“ã ã‚ˆã€‚</p>
        <p>â‘  æ€ã£ãŸã“ã¨ã‚’ä¸€è¨€ã¤ã¶ã‚„ãã€‚</p>
        <p>â‘¡ ã€Œè©±ã—ã‹ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã§è©±ã›ã¾ã™ã€‚</p>

        <!-- å…¥åŠ›æ¬„ -->
        <textarea id="userInput" placeholder="è©±ã—ãŸã„ã“ã¨ã‚’æ›¸ã„ã¦ã­"></textarea>

        <div class="buttons">
            <button id="voiceBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
            <button id="sendBtn">è©±ã—ã‹ã‘ã‚‹</button>
        </div>

        <!-- è¿”ç­” -->
        <div id="responseArea"></div>

        <!-- éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <audio id="voicePlayer" controls style="width: 100%; margin-top: 20px; display:none;"></audio>

        <!-- ãƒ­ã‚°è¡¨ç¤ºãƒªãƒ³ã‚¯ -->
        <p style="margin-top:30px;">
            <a href="/logs">ğŸ—‚ éå»ã®ä¼šè©±ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã‚‹</a>
        </p>
    </div>

    <script>
    /* -----------------------------------
       ğŸ¤ éŸ³å£°å…¥åŠ› â†’ è‡ªå‹•é€ä¿¡ï¼ˆ7ã€œ15ç§’ï¼‰
    ----------------------------------- */
    let recognizing = false;
    let recognition;
    let autoSendTimer = null;

    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "ja-JP";
        recognition.interimResults = true;

        recognition.onstart = () => {
            recognizing = true;
            console.log("[éŸ³å£°å…¥åŠ›] start");
        };

        recognition.onend = () => {
            recognizing = false;
            console.log("[éŸ³å£°å…¥åŠ›] end");
        };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            document.getElementById("userInput").value = text;

            if (autoSendTimer) clearTimeout(autoSendTimer);

            const len = text.length;
            const waitMs = len < 15 ? 7000 : 15000;

            autoSendTimer = setTimeout(() => {
                sendMessage();
            }, waitMs);
        };
    } catch (e) {
        console.warn("éŸ³å£°èªè­˜ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“:", e);
    }

    document.getElementById("voiceBtn").onclick = () => {
        if (recognition) recognition.start();
    };

    /* -----------------------------------
       âœ‰ï¸ é€ä¿¡å‡¦ç†
    ----------------------------------- */
    document.getElementById("sendBtn").onclick = () => {
        sendMessage();
    };

    function sendMessage() {
        const text = document.getElementById("userInput").value.trim();
        if (!text) return;

        document.getElementById("responseArea").innerHTML = "ã‚†ã†ãã‚“ãŒè€ƒãˆä¸­â€¦";

        fetch("/talk", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text})
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("responseArea").innerHTML = data.reply;

            const player = document.getElementById("voicePlayer");
            player.src = data.audio_url + "?t=" + new Date().getTime();
            player.style.display = "block";
            player.play();
        })
        .catch(err => {
            document.getElementById("responseArea").innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã¿ãŸã„â€¦ã”ã‚ã‚“ã­ã€‚";
            console.error(err);
        });

        document.getElementById("userInput").value = "";
    }
    </script>
</body>
</html>
